# å®‰å…¨ã€æƒé™ä¸å®¡è®¡

## è®¤è¯æœºåˆ¶

### ç™»å½•æ–¹æ¡ˆ

| é¡¹ç›® | å®ç° |
|------|------|
| è®¤è¯æ–¹å¼ | JWT (HS256) |
| å¯†ç å­˜å‚¨ | bcrypt å“ˆå¸Œ |
| Token å­˜å‚¨ | å®¢æˆ·ç«¯è‡ªæŒï¼ˆæ— æœåŠ¡ç«¯å­˜å‚¨ï¼‰ |
| Token æœ‰æ•ˆæœŸ | 24 å°æ—¶ |
| Token è½½è· | `sub=user_id`, `exp=è¿‡æœŸæ—¶é—´` |
| ç™»å‡ºå¤„ç† | ä»…æç¤ºå®¢æˆ·ç«¯åˆ é™¤ Tokenï¼Œæ— æœåŠ¡ç«¯å¤±æ•ˆ |

### è®¤è¯æµç¨‹

```
apps/api/routers/auth.py     # ç™»å½•/æ³¨å†Œè·¯ç”±
apps/api/services/auth_service.py  # å¯†ç æ ¡éªŒã€Token ç”Ÿæˆ
apps/api/deps.py             # get_current_user Token æ ¡éªŒ
```

### âš ï¸ Debug æ¨¡å¼æ—è·¯

| æ—è·¯ | ä½ç½® | é£é™© |
|------|------|------|
| æ—  Token ç›´æ¥è¿”å› admin ç”¨æˆ· | `apps/api/deps.py:get_current_user` | å®Œå…¨ç»•è¿‡è®¤è¯ |
| ç©ºå¯†ç ç™»å½•æ— å¯†ç å“ˆå¸Œç”¨æˆ· | `apps/api/services/auth_service.py:authenticate` | ä»»æ„è´¦æˆ·ç™»å½• |

**ç”Ÿäº§ç¯å¢ƒå¿…é¡»ç¡®ä¿ `config.debug=False`**

## æƒé™æ¨¡å‹

### ç”¨æˆ·/è§’è‰²ç»“æ„

```python
# packages/db/models.py
class UserRole(Enum):
    OWNER = "owner"
    ADMIN = "admin"
    MEMBER = "member"   # é»˜è®¤
    VIEWER = "viewer"
```

### æ•°æ®éš”ç¦»

| æœºåˆ¶ | å®ç°ä½ç½® |
|------|----------|
| ç§Ÿæˆ·éš”ç¦» | `get_current_tenant` ä¾èµ–æ³¨å…¥ |
| ç”¨æˆ·è¿‡æ»¤ | ä¸šåŠ¡æŸ¥è¯¢ä¸­ `tenant_id` æ¡ä»¶ |

### æƒé™æ£€æŸ¥ä½ç½®

| å±‚çº§ | å®ç° | çŠ¶æ€ |
|------|------|------|
| è·¯ç”±å±‚ | `Depends(get_current_user)` | âœ… å·²å®ç° |
| ç§Ÿæˆ·å±‚ | `Depends(get_current_tenant)` | âœ… å·²å®ç° |
| è§’è‰²å±‚ (RBAC) | æœªå®ç° | âŒ ç¼ºå¤± |

### âš ï¸ RBAC ç¼ºå¤±é—®é¢˜

| æ¥å£ | æ ‡æ³¨ | å®é™…æ£€æŸ¥ |
|------|------|----------|
| `apps/api/routers/console.py` | "ä»…é™ç®¡ç†å‘˜" | ä»…æ£€æŸ¥ç§Ÿæˆ·ï¼Œæ— è§’è‰²æ ¡éªŒ |
| `apps/api/routers/agent.py` | - | ä»…æ£€æŸ¥ç§Ÿæˆ·ï¼Œ`user_id=None` |

## å¸¸è§å®‰å…¨ç‚¹æ£€æŸ¥

### è¾“å…¥æ ¡éªŒ

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| Pydantic Schema | âœ… | åŸºç¡€ç±»å‹/é•¿åº¦æ ¡éªŒ |
| åˆ†é¡µå‚æ•° | âœ… | é™åˆ¶èŒƒå›´ |
| URL æ ¼å¼ | âš ï¸ | éƒ¨åˆ†æ¥å£ä¾èµ–åç»­è§£æ |
| æ‰¹é‡æ“ä½œæ•°é‡ | âœ… | `import_videos_batch` æœ‰æ•°é‡é™åˆ¶ |

### æ³¨å…¥é˜²æŠ¤

| ç±»å‹ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| SQL æ³¨å…¥ | âœ… | SQLAlchemy ORM å‚æ•°åŒ–æŸ¥è¯¢ |
| XSS | âš ï¸ | æ¥å£ç›´æ¥è¿”å›ç”¨æˆ·å†…å®¹ï¼Œéœ€å‰ç«¯è½¬ä¹‰ |
| CSRF | âœ… | Bearer Token è®¤è¯ï¼Œæ—  Cookie |
| SSRF | âŒ | ç”¨æˆ·å¯æŒ‡å®šä»»æ„ `base_url` |

### SSRF é£é™©ç‚¹

```python
# apps/api/routers/config.py
_fetch_models_from_endpoint(base_url)  # ç”¨æˆ·å¯æ§
fetch_llm_models(base_url)             # ç”¨æˆ·å¯æ§
# ç¼ºå°‘ URL ç™½åå•/å†…ç½‘é˜»æ–­
```

### æ–‡ä»¶æ“ä½œ

| æ£€æŸ¥é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| æ–‡ä»¶ä¸Šä¼  | N/A | æš‚æ— ä¸Šä¼ æ¥å£ |
| æ–‡ä»¶è¯»å– | âœ… | è·¯å¾„æ¥è‡ªæ•°æ®åº“ï¼Œéç”¨æˆ·ç›´æ¥è¾“å…¥ |

### CORS é…ç½®

| ç¯å¢ƒ | é…ç½® |
|------|------|
| Debug | `allow_origin_regex` å…è®¸ä»»æ„ localhost/127.* ç«¯å£ |
| ç”Ÿäº§ | âš ï¸ ä»å…è®¸å›ºå®šçš„ localhost/127.0.0.1/124.70.75.139 + `PUBLIC_HOST` |

**âš ï¸ ç”Ÿäº§ CORS é£é™©**: ä»»ä½•ç¯å¢ƒéƒ½æ”¾è¡Œ `localhost:3000/3002` å’Œå›ºå®šå…¬ç½‘ IPï¼Œå­˜åœ¨è·¨åŸŸæ”»å‡»é¢

## æ•æ„Ÿæ•°æ®å¤„ç†

### å¯†é’¥ç®¡ç†

| å¯†é’¥ | å­˜å‚¨ | é£é™© |
|------|------|------|
| `secret_key` | é…ç½®æ–‡ä»¶/ç¯å¢ƒå˜é‡ | é»˜è®¤å€¼ `change-me-in-production` |
| JWT ç­¾å | ä½¿ç”¨ `secret_key` | å…±ç”¨å¯†é’¥ |
| Bilibili å‡­è¯åŠ å¯† | ä½¿ç”¨ `secret_key` (Fernet) | å…±ç”¨å¯†é’¥ |

### å‡­è¯å­˜å‚¨

| æ•°æ® | å­˜å‚¨æ–¹å¼ | é£é™© |
|------|----------|------|
| ç”¨æˆ·å¯†ç  | bcrypt å“ˆå¸Œ | âœ… å®‰å…¨ |
| LLM/ASR API Key | æ˜æ–‡å­˜å‚¨ (`user_configs`) | âŒ é«˜é£é™© |
| å¹³å°ç»‘å®šå‡­è¯ | æ˜æ–‡ JSON (`user_platform_bindings.credentials`) | âŒ é«˜é£é™© |
| Bilibili SESSDATA | Fernet åŠ å¯† | âš ï¸ ä¾èµ– secret_key |

## å®¡è®¡ & æ—¥å¿—

### æ—¥å¿—æ¡†æ¶

- ä½¿ç”¨ `structlog` ç»“æ„åŒ–æ—¥å¿— (`packages/logging.py`)

### å®¡è®¡è®°å½•

| æ“ä½œ | æ˜¯å¦è®°å½• | ä½ç½® |
|------|----------|------|
| ç”¨æˆ·æ³¨å†Œ | âœ… | `AuthService` |
| ç”¨æˆ·ç™»å½• | âŒ | æœªè®°å½• |
| ç™»å½•å¤±è´¥ | âŒ | æœªè®°å½• |
| æƒé™å˜æ›´ | âŒ | æœªè®°å½• |
| å…³é”®ä¸šåŠ¡æ“ä½œ | âŒ | `TimelineService` å·²è®¾è®¡ä½†æœªè°ƒç”¨ |

### æ—¥å¿—å®‰å…¨

| æ£€æŸ¥é¡¹ | çŠ¶æ€ |
|--------|------|
| æ•æ„Ÿå­—æ®µè„±æ• | âŒ æœªå®ç° |
| é”™è¯¯è¯¦æƒ…è¿‡æ»¤ | âŒ å¯èƒ½æ³„éœ² URL/é…ç½® |

## å®‰å…¨é£é™©æ¸…å•

### ğŸ”´ é«˜é£é™©

| # | é£é™© | ä½ç½® | å½±å“ | å»ºè®® |
|---|------|------|------|------|
| 1 | Debug æ¨¡å¼è®¤è¯æ—è·¯ | `apps/api/deps.py`, `auth_service.py` | æ—  Token è·å– adminï¼Œç©ºå¯†ç ç™»å½• | ç”Ÿäº§å¼ºåˆ¶å…³é—­ debugï¼›ç§»é™¤æ—è·¯é€»è¾‘ |
| 2 | `secret_key` é»˜è®¤å¼±å€¼ | `packages/config/settings.py` | Token ä¼ªé€ ï¼Œå‡­è¯è§£å¯† | ç”Ÿäº§å¿…é¡»è¦†ç›–ä¸ºå¼ºéšæœºå€¼ |
| 3 | RBAC ç¼ºå¤± | `apps/api/routers/console.py` | ä»»æ„ç”¨æˆ·è®¿é—®ç®¡ç†åŠŸèƒ½ | å®ç°è§’è‰²æ£€æŸ¥ä¸­é—´ä»¶ |
| 4 | API Key / å¹³å°å‡­è¯æ˜æ–‡å­˜å‚¨ | `apps/api/routers/config.py`; `user_platform_bindings.credentials` | æ•°æ®åº“æ³„éœ²å³è·å–æ‰€æœ‰å¤–éƒ¨ä¸ç¬¬ä¸‰æ–¹å‡­è¯ | åŠ å¯†å­˜å‚¨ï¼Œåˆ†ç¦»åŠ è§£å¯†å¯†é’¥ |

### ğŸŸ¡ ä¸­é£é™©

| # | é£é™© | ä½ç½® | å½±å“ | å»ºè®® |
|---|------|------|------|------|
| 5 | SSRF | `apps/api/routers/config.py` | å†…ç½‘æ¢æµ‹/æ”»å‡» | æ·»åŠ  URL ç™½åå•/å†…ç½‘é˜»æ–­ |
| 6 | Token æ— å¤±æ•ˆæœºåˆ¶ | `apps/api/deps.py` | å¯†ç å˜æ›´/ç¦ç”¨åæ—§ Token ä»æœ‰æ•ˆ | å®ç° Token é»‘åå•æˆ–çŸ­æœ‰æ•ˆæœŸ |
| 7 | æœªæ ¡éªŒ `is_active`ï¼ˆç™»å½•ä¸é‰´æƒï¼‰ | `apps/api/deps.py`, `apps/api/routers/auth.py` | ç¦ç”¨è´¦æˆ·ä»å¯ç™»å½•å¹¶è·å–æ–° Token | ç™»å½•å’Œé‰´æƒéƒ½æ·»åŠ  `is_active` æ£€æŸ¥ |
| 8 | æ— ç™»å½•é€Ÿç‡é™åˆ¶ | `apps/api/routers/auth.py` | æš´åŠ›ç ´è§£ | æ·»åŠ é€Ÿç‡é™åˆ¶ä¸­é—´ä»¶ |
| 9 | ç”Ÿäº§ CORS å…è®¸ localhost/å›ºå®š IP | `apps/api/main.py` | ä»»æ„ç«™ç‚¹å¯è·¨åŸŸè°ƒç”¨æ¥å£ | æŒ‰ç¯å¢ƒåŠ è½½ `allow_origins`ï¼Œç”Ÿäº§ä»…å…è®¸å—ä¿¡åŸŸå |

### ğŸŸ¢ ä½é£é™©

| # | é£é™© | ä½ç½® | å½±å“ | å»ºè®® |
|---|------|------|------|------|
| 10 | æ— é‰´æƒä¿¡æ¯æ¥å£ | `/api/v1/videos/queue/info`, `/api/v1/agent/strategies` | ç³»ç»ŸçŠ¶æ€æ³„éœ² | æ·»åŠ è®¤è¯æˆ–é™åˆ¶ä¿¡æ¯ |
| 11 | XSSï¼ˆå­˜å‚¨å‹ï¼‰ | è§†é¢‘æ ‡é¢˜/è½¬å†™/è¯„è®ºè¿”å› | å‰ç«¯æ¸²æŸ“æ¶æ„è„šæœ¬ | å‰ç«¯ç»Ÿä¸€ HTML è½¬ä¹‰ |
| 12 | æ—¥å¿—æ— è„±æ• | `packages/logging.py` | æ•æ„Ÿä¿¡æ¯æ³„éœ² | æ·»åŠ æ•æ„Ÿå­—æ®µè¿‡æ»¤ |

## å®‰å…¨åŠ å›ºå»ºè®®

### ç«‹å³ä¿®å¤ï¼ˆä¸Šçº¿å‰ï¼‰

```python
# 1. ç§»é™¤ debug æ—è·¯æˆ–æ·»åŠ ç¯å¢ƒæ£€æŸ¥
# apps/api/deps.py
async def get_current_user(...):
    # åˆ é™¤ debug æ¨¡å¼ä¸‹çš„ admin è¿”å›é€»è¾‘
    if not token:
        raise HTTPException(401, "Not authenticated")

# 2. æ·»åŠ  is_active æ£€æŸ¥
if not user.is_active:
    raise HTTPException(403, "Account disabled")

# 3. å®ç° RBAC è£…é¥°å™¨
def require_role(role: UserRole):
    def decorator(func):
        @wraps(func)
        async def wrapper(*args, user=Depends(get_current_user), **kwargs):
            if user.role != role:
                raise HTTPException(403, "Insufficient permissions")
            return await func(*args, user=user, **kwargs)
        return wrapper
    return decorator
```

### çŸ­æœŸæ”¹è¿›

1. å®ç° Token é»‘åå•ï¼ˆRedisï¼‰
2. æ·»åŠ ç™»å½•é€Ÿç‡é™åˆ¶
3. åŠ å¯†å­˜å‚¨ API Key å’Œå¹³å°å‡­è¯
4. æ·»åŠ  SSRF é˜²æŠ¤ï¼ˆURL ç™½åå•ï¼‰

### é•¿æœŸè§„åˆ’

1. å®Œå–„å®¡è®¡æ—¥å¿—ç³»ç»Ÿ
2. å®ç°æ—¥å¿—è„±æ•
3. æ·»åŠ å®‰å…¨ç›‘æ§å‘Šè­¦
4. å®šæœŸå®‰å…¨å®¡è®¡
