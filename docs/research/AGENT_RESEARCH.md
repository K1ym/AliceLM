# 🔬 Agent 系统调研报告

> 注：本报告基于 2024-12 代码状态撰写，当时后端仍是固定问答流程。现在仓库已具备 `AliceAgentCore` 骨架和工具路由，但 ReAct 主循环/Planner 未接线，最新路线图请看 `docs/strategy/ROADMAP.md` 与 `docs/strategy/ai_project_audit/08_upgrade_roadmap.md`。

---

## 目录

1. [AliceLM 现状分析](#1-alicelm-现状分析)
2. [Gemini CLI 分析](#2-gemini-cli-分析)
3. [graph-rag-agent 分析](#3-graph-rag-agent-分析)
4. [OpenManus 分析](#4-openmanus-分析)
5. [SurfSense 分析](#5-surfsense-分析) ⭐ **最相关**
6. [五项目完整对比](#6-五项目完整对比)
7. [AliceLM 升级建议](#7-alicelm-升级建议)

---

## 1. AliceLM 现状分析

### 1.1 产品定位

| 维度 | 描述 |
|------|------|
| **愿景** | 让每一个信息，都变成可检索、可理解、可回顾的知识资产 |
| **核心问题** | 收藏视频 = 假装学习；知识碎片化 |
| **目标用户** | 知识工作者、终身学习者 |
| **产品形态** | 微信Bot + Web UI + MCP Server |

### 1.2 技术栈

```
┌─────────────────────────────────────────────────────────────────┐
│                        AliceLM 技术栈                            │
├─────────────────────────────────────────────────────────────────┤
│  前端:  Next.js 14 + TypeScript + TailwindCSS + Lucide Icons    │
│  后端:  FastAPI + SQLAlchemy + Pydantic                         │
│  数据:  SQLite/PostgreSQL + ChromaDB (向量)                     │
│  AI:    OpenAI API (兼容) + Whisper API                         │
│  部署:  Docker Compose                                          │
└─────────────────────────────────────────────────────────────────┘
```

### 1.3 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         Clients                                  │
├──────────┬──────────┬──────────┬──────────┬────────────────────┤
│ Web UI   │ 微信Bot  │ MCP      │ CLI      │                    │
└────┬─────┴────┬─────┴────┬─────┴────┬─────┘                    │
     │          │          │          │                           │
     ▼          ▼          ▼          ▼                           │
┌─────────────────────────────────────────────────────────────────┤
│                    FastAPI + JWT Auth                            │
├─────────────────────────────────────────────────────────────────┤
│  Routers:                                                        │
│  ├── videos.py      # 视频 CRUD                                 │
│  ├── qa.py          # 问答接口                                  │
│  ├── chat.py        # 对话管理                                  │
│  ├── config.py      # 配置管理                                  │
│  ├── knowledge.py   # 知识图谱                                  │
│  └── bilibili.py    # B站集成                                   │
├─────────────────────────────────────────────────────────────────┤
│  Services (业务层):                                              │
│  ├── VideoService                                                │
│  ├── ChatService                                                 │
│  ├── ConfigService                                               │
│  └── BilibiliService                                             │
├─────────────────────────────────────────────────────────────────┤
│  Repositories (数据层):                                          │
│  ├── VideoRepository                                             │
│  ├── UserRepository                                              │
│  ├── ConversationRepository                                      │
│  └── ConfigRepository                                            │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Services Layer                              │
├─────────────────────────────────────────────────────────────────┤
│  services/                                                       │
│  ├── ai/                  # AI 能力                             │
│  │   ├── llm/            # LLM 管理                             │
│  │   ├── rag/            # RAG (ChromaDB)                       │
│  │   └── summarizer.py   # 摘要生成                             │
│  ├── asr/                 # 语音识别                            │
│  ├── processor/           # 视频处理管道                         │
│  ├── knowledge/           # 知识图谱服务                         │
│  ├── notifier/            # 通知服务                            │
│  └── watcher/             # 收藏夹监控                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Data Layer                                 │
├─────────────────────────────────────────────────────────────────┤
│  SQLite/PostgreSQL          ChromaDB              File Storage   │
│  ├── tenants               ├── embeddings         ├── videos/   │
│  ├── users                 └── indexes            ├── audios/   │
│  ├── videos                                       └── transcripts│
│  ├── conversations                                               │
│  └── configs                                                     │
└─────────────────────────────────────────────────────────────────┘
```

### 1.4 视频处理流程

```
用户收藏视频
      │
      ▼
┌─────────────────┐
│ 1. DOWNLOADING  │ ── BBDown/yt-dlp 下载音频
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 2. TRANSCRIBING │ ── Whisper API 转写
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 3. ANALYZING    │ ── LLM 生成摘要/观点/概念
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 4. INDEXING     │ ── ChromaDB 向量化 (新增)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 5. DONE         │ ── 发送通知
└─────────────────┘
```

### 1.5 前端页面结构

```
apps/web/src/app/
├── page.tsx              # Landing 页
├── login/                # 登录
├── register/             # 注册
└── home/                 # 主应用 (需登录)
    ├── page.tsx          # Dashboard + 对话
    ├── library/          # 视频库
    │   └── page.tsx
    ├── video/            # 视频详情
    │   └── [id]/page.tsx
    ├── graph/            # 知识图谱 (新增)
    │   └── page.tsx
    └── settings/         # 设置
        └── page.tsx
```

### 1.6 功能完成度

| 模块 | 功能 | 状态 |
|------|------|------|
| **视频处理** | 下载、转写、分析 | ✅ 完成 |
| **对话问答** | 单视频问答 | ✅ 完成 |
| **RAG搜索** | ChromaDB 向量检索 | ✅ 完成 |
| **知识图谱** | 概念提取、可视化 | ⚠️ 基础版 |
| **MCP Server** | 工具暴露 | ✅ 完成 |
| **多端配置** | LLM/ASR/Embedding | ✅ 完成 |
| **用户系统** | 注册/登录/多租户 | ✅ 完成 |

### 1.7 当前问答流程 (无 Agent)

```python
# 当前实现: 固定流程
def answer_question(question, video_id=None):
    # Step 1: 检索
    if video_id:
        context = get_video_transcript(video_id)
    else:
        context = rag_search(question)  # ChromaDB
    
    # Step 2: 生成
    answer = llm_generate(
        prompt=f"根据以下内容回答: {context}\n问题: {question}"
    )
    
    return answer
```

**问题:**
- 无法处理复杂问题 (如"对比两个视频")
- 无法动态决策 (是否需要搜索、搜索什么)
- 无法多步推理

### 1.8 UI/UX 设计

| 维度 | 描述 |
|------|------|
| **设计语言** | 简约中性、专业克制 |
| **配色** | Neutral 灰度为主 |
| **组件库** | 自定义 + Lucide Icons |
| **响应式** | 支持移动端 |
| **交互模式** | 侧边栏导航 + 对话式交互 |

---

## 2. Gemini CLI 分析

### 2.1 项目概览

| 维度 | 描述 |
|------|------|
| **定位** | 终端 AI Agent，直连 Gemini |
| **开发者** | Google |
| **开源协议** | Apache 2.0 |
| **语言** | TypeScript |
| **Star数** | 30K+ |

### 2.2 架构设计

```
┌─────────────────────────────────────────────────────────────────┐
│                      Gemini CLI 架构                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                   packages/cli (前端)                      │  │
│  │  ├── 用户输入处理                                         │  │
│  │  ├── 历史管理                                             │  │
│  │  ├── 显示渲染                                             │  │
│  │  └── 主题/UI 定制                                         │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                  packages/core (后端)                      │  │
│  │  ├── Gemini API 客户端                                    │  │
│  │  ├── Prompt 构建管理                                      │  │
│  │  ├── Tool 注册与执行                                      │  │
│  │  └── 会话状态管理                                         │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                   Tools (工具层)                           │  │
│  │  ├── read_file, write_file, edit    # 文件操作           │  │
│  │  ├── list_directory, find_files     # 目录操作           │  │
│  │  ├── run_shell_command              # Shell 执行         │  │
│  │  ├── web_fetch                      # 网页获取           │  │
│  │  ├── google_web_search              # 网页搜索           │  │
│  │  ├── save_memory                    # 记忆存储           │  │
│  │  └── write_todos                    # 任务管理           │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.3 核心机制: Function Calling 循环

```
用户输入: "帮我总结 README.md 的内容"
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│  Core 构建请求:                                                  │
│  {                                                               │
│    "messages": [{"role": "user", "content": "帮我总结..."}],    │
│    "tools": [                                                    │
│      {"name": "read_file", "description": "读取文件"},          │
│      {"name": "write_file", "description": "写入文件"},         │
│      ...                                                         │
│    ]                                                             │
│  }                                                               │
└─────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│  Gemini API 返回:                                                │
│  {                                                               │
│    "function_call": {                                            │
│      "name": "read_file",                                        │
│      "arguments": {"path": "README.md"}                          │
│    }                                                             │
│  }                                                               │
└─────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│  Core 执行工具:                                                  │
│  - 敏感操作 (write/shell) → 请求用户确认                        │
│  - 只读操作 (read) → 直接执行                                   │
│  - 执行结果添加到对话历史                                       │
└─────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│  继续调用 Gemini API (带工具结果)                                │
│  → 模型可能继续调用工具，或返回最终答案                          │
└─────────────────────────────────────────────────────────────────┘
                    │
                    ▼
              最终答案显示给用户
```

### 2.4 工具分类

| 类别 | 工具 | 需确认 | 说明 |
|------|------|--------|------|
| **文件读取** | read_file, list_directory | ❌ | 安全操作 |
| **文件写入** | write_file, edit | ✅ | 修改文件 |
| **Shell** | run_shell_command | ✅ | 执行命令 |
| **网络** | web_fetch, google_web_search | ❌ | 获取信息 |
| **记忆** | save_memory | ❌ | 跨会话记忆 |
| **任务** | write_todos | ❌ | 任务管理 |

### 2.5 关键设计原则

| 原则 | 实现 |
|------|------|
| **模块化** | CLI/Core 分离 |
| **可扩展** | 工具插件化 |
| **安全** | 敏感操作需确认 |
| **沙箱** | Docker/sandbox-exec 隔离 |
| **MCP支持** | 可接入 MCP Server |

---

## 3. graph-rag-agent 分析

### 3.1 项目概览

| 维度 | 描述 |
|------|------|
| **定位** | GraphRAG + DeepSearch 知识问答系统 |
| **开发者** | MetaGPT 社区 |
| **开源协议** | MIT |
| **语言** | Python |
| **特色** | 多 Agent 协作、知识图谱、证据链追踪 |

### 3.2 架构设计

```
┌─────────────────────────────────────────────────────────────────┐
│                    graph-rag-agent 架构                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              Streamlit Frontend (frontend/app.py)          │  │
│  │  ├── 聊天界面                                              │  │
│  │  ├── 调试面板                                              │  │
│  │  ├── 知识图谱可视化                                        │  │
│  │  └── KG 管理                                               │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              FastAPI + SSE (server/main.py)                │  │
│  │  ├── RESTful API                                           │  │
│  │  └── Server-Sent Events (流式响应)                         │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              Agent Manager (会话池)                         │  │
│  │  └── 每个会话维护独立的 Agent 实例                         │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              Agent 选择 (Router)                            │  │
│  │  ├── NaiveRagAgent      (简单向量搜索)                     │  │
│  │  ├── GraphAgent         (纯图谱搜索)                       │  │
│  │  ├── HybridAgent        (向量+图谱)                        │  │
│  │  ├── DeepResearchAgent  (深度研究)                         │  │
│  │  └── FusionGraphRAGAgent (多智能体协作)                    │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│            ┌─────────────────┴─────────────────┐                │
│            ▼                                   ▼                │
│  ┌──────────────────────┐     ┌──────────────────────────────┐ │
│  │   简单 Agent 直接执行 │     │   FusionAgent 多智能体协作    │ │
│  └──────────────────────┘     └──────────────────────────────┘ │
│                                           │                     │
│                          ┌────────────────┼────────────────┐   │
│                          ▼                ▼                ▼   │
│                   ┌──────────┐    ┌──────────┐    ┌──────────┐ │
│                   │ Planner  │    │ Executor │    │ Reporter │ │
│                   │ (规划层) │    │ (执行层) │    │ (报告层) │ │
│                   └──────────┘    └──────────┘    └──────────┘ │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Core Services                              │
├─────────────────────────────────────────────────────────────────┤
│  ├── cache_manager/     # 三级缓存 (内存/磁盘/向量)             │
│  ├── search/            # 搜索系统                              │
│  │   ├── local_search   # 本地搜索                              │
│  │   ├── global_search  # 全局搜索                              │
│  │   └── tool_registry  # 工具注册 (15+ 工具)                   │
│  ├── graph/             # 图谱构建                              │
│  └── community/         # 社区检测                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Data Layer                                │
├─────────────────────────────────────────────────────────────────┤
│  Neo4j (图数据库)              FAISS (向量数据库)                │
│  ├── 实体                      ├── 文档 embeddings              │
│  ├── 关系                      └── 索引                         │
│  └── 社区                                                        │
└─────────────────────────────────────────────────────────────────┘
```

### 3.3 多智能体 Plan-Execute-Report 架构

```
用户问题: "对比 GraphRAG 和 LightRAG 的优缺点"
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Planner (规划层)                              │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Clarifier (澄清器)                                       │   │
│  │  - 理解用户意图                                           │   │
│  │  - 识别模糊点                                             │   │
│  └──────────────────────────────────────────────────────────┘   │
│                         │                                        │
│                         ▼                                        │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  TaskDecomposer (任务分解器)                              │   │
│  │  Output:                                                  │   │
│  │  {                                                        │   │
│  │    "tasks": [                                             │   │
│  │      {"id": 1, "action": "search", "query": "GraphRAG"},  │   │
│  │      {"id": 2, "action": "search", "query": "LightRAG"},  │   │
│  │      {"id": 3, "action": "compare", "depends": [1, 2]}    │   │
│  │    ]                                                      │   │
│  │  }                                                        │   │
│  └──────────────────────────────────────────────────────────┘   │
│                         │                                        │
│                         ▼                                        │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  PlanReviewer (计划审核器)                                │   │
│  │  - 检查计划合理性                                         │   │
│  │  - 优化执行顺序                                           │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Executor (执行层)                             │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  WorkerCoordinator (工作协调器)                           │   │
│  │  - 并行/串行任务调度                                      │   │
│  │  - 依赖关系管理                                           │   │
│  └──────────────────────────────────────────────────────────┘   │
│                         │                                        │
│                         ▼                                        │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  EvidenceTracker (证据追踪器)                             │   │
│  │  - 记录每步检索结果                                       │   │
│  │  - 构建证据链                                             │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Reporter (报告层)                             │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  OutlineBuilder (大纲构建器)                              │   │
│  └──────────────────────────────────────────────────────────┘   │
│                         │                                        │
│                         ▼                                        │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  SectionWriter (章节撰写器)                               │   │
│  └──────────────────────────────────────────────────────────┘   │
│                         │                                        │
│                         ▼                                        │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  ConsistencyChecker (一致性检查器)                        │   │
│  └──────────────────────────────────────────────────────────┘   │
│                         │                                        │
│                         ▼                                        │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  ReportAssembler (报告组装器)                             │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                         │
                         ▼
                 结构化回答 + 证据引用
```

### 3.4 工具注册表

| 工具 | 类型 | 说明 |
|------|------|------|
| local_search | 搜索 | 本地上下文搜索 |
| global_search | 搜索 | 全局语义搜索 |
| hybrid_search | 搜索 | 向量+图谱混合 |
| naive_search | 搜索 | 简单向量搜索 |
| deep_research | 研究 | 深度研究 |
| deeper_research | 研究 | 更深度研究 |
| chain_exploration | 推理 | 链式探索 |
| hypothesis_generator | 推理 | 假设生成 |
| answer_validator | 验证 | 答案验证 |

### 3.5 关键特性

| 特性 | 说明 |
|------|------|
| **质量感知缓存** | 高质量结果 (score>2) 走快速路径 |
| **证据链追踪** | 完整溯源: 问题→搜索→检索→推理→答案 |
| **双存储模型** | Neo4j (图关系) + FAISS (向量) |
| **多Agent协作** | Plan-Execute-Report 三阶段 |

---

## 4. OpenManus 分析

### 4.1 项目概览

| 维度 | 描述 |
|------|------|
| **定位** | 通用 AI Agent 框架 |
| **开发者** | MetaGPT 团队 |
| **开源协议** | MIT |
| **语言** | Python |
| **特色** | 层级 Agent 设计、ReAct 模式、浏览器自动化 |

### 4.2 Agent 继承层次

```
┌─────────────────────────────────────────────────────────────────┐
│                    OpenManus Agent 继承链                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  BaseAgent                                                 │  │
│  │  - 基础能力: 记忆、LLM调用                                 │  │
│  └─────────────────────────┬─────────────────────────────────┘  │
│                            │                                     │
│                            ▼                                     │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  ReActAgent                                                │  │
│  │  - 添加: Think → Act → Observe 循环                       │  │
│  │  - 实现显式的推理过程                                     │  │
│  └─────────────────────────┬─────────────────────────────────┘  │
│                            │                                     │
│                            ▼                                     │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  ToolCallAgent                                             │  │
│  │  - 添加: 工具注册与调用抽象                                │  │
│  │  - Function Calling 封装                                   │  │
│  └─────────────────────────┬─────────────────────────────────┘  │
│                            │                                     │
│                            ▼                                     │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  PlanningAgent                                             │  │
│  │  - 添加: 任务规划与状态追踪                                │  │
│  │  - 结构化计划管理                                         │  │
│  └─────────────────────────┬─────────────────────────────────┘  │
│                            │                                     │
│                            ▼                                     │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  Manus (主入口)                                            │  │
│  │  - 用户交互入口                                           │  │
│  │  - 整合所有能力                                           │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 4.3 ReAct 执行循环

```
用户输入: "帮我分析这个网站并生成报告"
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 1: 任务规划 (PlanningAgent)                                │
│                                                                  │
│  LLM 生成结构化计划:                                            │
│  {                                                               │
│    "goal": "分析网站并生成报告",                                │
│    "steps": [                                                    │
│      {"id": 1, "task": "打开目标网站", "status": "pending"},    │
│      {"id": 2, "task": "提取关键信息", "status": "pending"},    │
│      {"id": 3, "task": "分析数据", "status": "pending"},        │
│      {"id": 4, "task": "生成报告", "status": "pending"}         │
│    ]                                                             │
│  }                                                               │
└─────────────────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│  Step 2-N: ReAct 循环 (每个步骤)                                 │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                     THINK (思考)                         │    │
│  │  LLM: "当前需要打开网站，我应该使用 BrowserUseTool"       │    │
│  └───────────────────────────┬─────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                      ACT (行动)                          │    │
│  │  执行: BrowserUseTool.navigate(url="https://...")        │    │
│  └───────────────────────────┬─────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    OBSERVE (观察)                        │    │
│  │  结果: "页面加载成功，标题: xxx，内容: ..."              │    │
│  └───────────────────────────┬─────────────────────────────┘    │
│                              │                                   │
│                              ▼                                   │
│                    更新计划状态，进入下一步                      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
                         │
                         ▼
                   完成 / 终止
```

### 4.4 工具层

| 工具 | 类型 | 说明 |
|------|------|------|
| **PythonExecute** | 代码 | 执行 Python 代码 |
| **BrowserUseTool** | 浏览器 | 网页导航、元素交互、截图 |
| **GoogleSearch** | 搜索 | Google 搜索 |
| **FileSaver** | 文件 | 保存文件 |
| **PlanningTool** | 管理 | 计划管理 |
| **CreateChatCompletion** | LLM | 创建对话 |
| **Terminate** | 控制 | 终止执行 |

### 4.5 关键设计特点

| 特点 | 说明 |
|------|------|
| **层级继承** | 每层增加特定能力，清晰可扩展 |
| **显式 ReAct** | Think-Act-Observe 循环 |
| **结构化规划** | 任务分解、状态追踪 |
| **浏览器自动化** | 独有能力 |
| **MCP 支持** | 可运行 MCP 工具 |

---

## 5. SurfSense 分析 ⭐

> **最相关项目**: NotebookLM/Perplexity 开源替代，与 AliceLM 目标高度一致

### 5.1 项目概览

| 维度 | 描述 |
|------|------|
| **定位** | NotebookLM + Perplexity + Glean 开源替代 |
| **开发者** | MODSetter |
| **开源协议** | MIT |
| **语言** | Python + TypeScript |
| **Star数** | 10K+ |
| **特色** | 多源集成、Podcast生成、引用回答、团队协作 |

### 5.2 架构设计

```
┌─────────────────────────────────────────────────────────────────┐
│                      SurfSense 架构                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              Next.js Frontend (surfsense_web/)             │  │
│  │  ├── Dashboard                                             │  │
│  │  ├── Chat 界面                                             │  │
│  │  ├── Search Space 管理                                     │  │
│  │  ├── Connector 配置                                        │  │
│  │  └── Podcast 生成                                          │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              FastAPI Backend (surfsense_backend/)          │  │
│  │  ├── FastAPI Users (JWT/OAuth)                             │  │
│  │  ├── RESTful API                                           │  │
│  │  └── Agent 路由                                            │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│          ┌───────────────────┼───────────────────┐              │
│          ▼                   ▼                   ▼              │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │  Q&A Agent  │    │  Researcher │    │  Podcaster  │         │
│  │  (问答)     │    │  Agent      │    │  Agent      │         │
│  │             │    │  (研究)     │    │  (播客)     │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│          │                   │                   │              │
│          └───────────────────┼───────────────────┘              │
│                              ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              LangGraph Workflow Engine                     │  │
│  │  ├── 节点 (Nodes): 检索、生成、重排序                      │  │
│  │  ├── 边 (Edges): 条件路由                                  │  │
│  │  └── 状态 (State): 对话上下文                              │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              Celery + Redis (异步任务队列)                  │  │
│  │  ├── 文档索引任务                                          │  │
│  │  ├── Connector 同步任务                                    │  │
│  │  └── Podcast 生成任务                                      │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │              PostgreSQL + pgvector                         │  │
│  │  ├── 用户/权限                                             │  │
│  │  ├── Search Spaces                                         │  │
│  │  ├── Documents + Chunks                                    │  │
│  │  ├── Connectors                                            │  │
│  │  └── Vector Embeddings (HNSW)                              │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.3 Agent 系统 (LangGraph)

```
用户问题: "总结我 Notion 中关于 AI 的笔记"
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Q&A Agent (问答代理)                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  Node 1: 文档级检索                                        │  │
│  │  - 从 Search Space 中检索相关文档                          │  │
│  │  - Hybrid Search (向量 + 全文)                             │  │
│  │  - Reciprocal Rank Fusion (RRF)                            │  │
│  └───────────────────────────┬───────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  Node 2: Chunk级检索                                       │  │
│  │  - 对选中文档进行细粒度检索                                │  │
│  │  - 获取最相关的 chunks                                     │  │
│  └───────────────────────────┬───────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  Node 3: 重排序 (可选)                                     │  │
│  │  - FlashRank / Cohere / Pinecone Reranker                  │  │
│  │  - 优化检索结果排序                                        │  │
│  └───────────────────────────┬───────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  Node 4: Token 优化                                        │  │
│  │  - optimize_documents_for_token_limit                      │  │
│  │  - 二分查找算法最大化文档利用                              │  │
│  └───────────────────────────┬───────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  Node 5: 回答生成                                          │  │
│  │  - LLM 生成带引用的回答                                    │  │
│  │  - 格式: [citation:source_id]                              │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
                         │
                         ▼
              带引用的结构化回答
```

### 5.4 核心特性

| 特性 | 说明 |
|------|------|
| **Search Space** | 隔离的知识空间，每个空间独立配置 |
| **13+ Connectors** | Slack, Notion, GitHub, Linear, Jira, Discord, Gmail... |
| **引用回答** | 类似 Perplexity 的 [citation:id] 格式 |
| **Podcast 生成** | 3分钟播客 <20秒生成 (Kokoro TTS) |
| **Hybrid Search** | 向量 + 全文 + RRF 融合 |
| **2层 RAG** | 文档级 → Chunk级 层级检索 |
| **6000+ Embedding** | AutoEmbeddings 支持海量模型 |
| **100+ LLM** | LiteLLM 支持所有主流模型 |
| **RBAC** | 团队协作、角色权限 |

### 5.5 Connector 系统

```
┌─────────────────────────────────────────────────────────────────┐
│                    Connector 类型                                │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  搜索引擎:                                                       │
│  ├── Tavily (AI搜索)                                            │
│  ├── SearxNG (自托管)                                           │
│  ├── LinkUp                                                      │
│  └── Baidu                                                       │
│                                                                  │
│  协作工具:                                                       │
│  ├── Slack                                                       │
│  ├── Discord                                                     │
│  ├── Linear                                                      │
│  ├── Jira                                                        │
│  ├── ClickUp                                                     │
│  └── Confluence                                                  │
│                                                                  │
│  知识库:                                                         │
│  ├── Notion                                                      │
│  ├── GitHub                                                      │
│  ├── Airtable                                                    │
│  └── Elasticsearch                                               │
│                                                                  │
│  其他:                                                           │
│  ├── Gmail                                                       │
│  ├── Google Calendar                                             │
│  ├── YouTube                                                     │
│  └── Luma                                                        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.6 文档处理流程

```
文件上传 / URL / Connector
           │
           ▼
┌─────────────────────────────────────────────────────────────────┐
│  ETL 服务选择:                                                   │
│  ├── Unstructured.io (API, 34+ 格式)                            │
│  ├── LlamaCloud (API, 50+ 格式)                                 │
│  └── Docling (本地, PDF/Office/HTML)                            │
└─────────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────────┐
│  处理流程:                                                       │
│  1. 解析文档内容                                                 │
│  2. LLM 生成摘要                                                 │
│  3. Chunking (RecursiveChunker / CodeChunker)                   │
│  4. LateChunker 优化 (基于 max_seq_length)                      │
│  5. AutoEmbeddings 生成向量                                     │
│  6. 存储到 pgvector (HNSW 索引)                                 │
│  7. 内容去重 (content_hash)                                     │
└─────────────────────────────────────────────────────────────────┘
```

### 5.7 技术栈

| 层级 | 技术 |
|------|------|
| **前端** | Next.js, TailwindCSS, Zustand |
| **后端** | FastAPI, FastAPI Users, SQLAlchemy |
| **Agent** | LangGraph, LangChain |
| **LLM** | LiteLLM (100+ 模型) |
| **Embedding** | Chonkie AutoEmbeddings (6000+ 模型) |
| **Reranker** | FlashRank, Cohere, Pinecone |
| **数据库** | PostgreSQL + pgvector |
| **队列** | Celery + Redis |
| **TTS** | Kokoro (本地), OpenAI, Azure, Google |
| **监控** | Flower (Celery监控) |

### 5.8 与 AliceLM 的关键差异

| 维度 | AliceLM | SurfSense |
|------|---------|-----------|
| **数据源** | B站视频 | 13+ 平台 |
| **RAG** | 单层 ChromaDB | 2层 Hybrid + Reranker |
| **Agent** | 无 | LangGraph 工作流 |
| **引用** | 无 | [citation:id] |
| **Podcast** | 无 | ✅ 快速生成 |
| **团队** | 单用户 | RBAC 多用户 |
| **向量DB** | ChromaDB | pgvector |

---

## 6. 五项目完整对比

### 6.1 架构对比

| 维度 | AliceLM | Gemini CLI | graph-rag-agent | OpenManus | SurfSense |
|------|---------|-----------|-----------------|-----------|-----------|
| **架构模式** | 分层服务 | 工具循环 | 多Agent协作 | ReAct+规划 | LangGraph工作流 |
| **Agent设计** | 无 | 隐式 | 扁平多Agent | 层级继承 | 专用Agent |
| **决策机制** | 硬编码 | LLM选工具 | 路由+规划 | ReAct循环 | 节点路由 |
| **规划能力** | ❌ | ❌ | ✅ Planner | ✅ PlanningAgent | ⚠️ 隐式 |

### 6.2 能力对比

| 能力 | AliceLM | Gemini CLI | graph-rag-agent | OpenManus | SurfSense |
|------|---------|-----------|-----------------|-----------|------------|
| **向量搜索** | ✅ ChromaDB | ❌ | ✅ FAISS | ❌ | ✅ pgvector |
| **知识图谱** | ⚠️ 基础 | ❌ | ✅ Neo4j | ❌ | ❌ |
| **文件操作** | ❌ | ✅ | ❌ | ✅ | ✅ 50+格式 |
| **Shell执行** | ❌ | ✅ | ❌ | ✅ Python | ❌ |
| **网页搜索** | ❌ | ✅ | ❌ | ✅ | ✅ 多引擎 |
| **浏览器控制** | ❌ | ❌ | ❌ | ✅ | ❌ |
| **记忆系统** | ⚠️ 对话历史 | ✅ | ✅ 三级缓存 | ⚠️ | ✅ |
| **多跳推理** | ❌ | ⚠️ 循环 | ✅ | ✅ | ⚠️ 2层RAG |
| **证据追踪** | ❌ | ❌ | ✅ | ⚠️ | ✅ 引用 |
| **MCP支持** | ✅ | ✅ | ❌ | ✅ | ❌ |
| **Podcast** | ❌ | ❌ | ❌ | ❌ | ✅ |
| **多源集成** | ⚠️ B站 | ❌ | ❌ | ❌ | ✅ 13+ |

### 6.3 技术栈对比

| 维度 | AliceLM | Gemini CLI | graph-rag-agent | OpenManus | SurfSense |
|------|---------|-----------|-----------------|-----------|------------|
| **语言** | Python + TS | TypeScript | Python | Python | Python + TS |
| **前端** | Next.js | Terminal | Streamlit | Terminal | Next.js |
| **后端** | FastAPI | Node.js | FastAPI | Python | FastAPI |
| **LLM** | OpenAI兼容 | Gemini | 多LLM | 多LLM | LiteLLM 100+ |
| **向量DB** | ChromaDB | - | FAISS | - | pgvector |
| **图DB** | - | - | Neo4j | - | - |
| **Agent框架** | - | - | 自建 | 自建 | LangGraph |
| **任务队列** | - | - | - | - | Celery |

### 6.4 LLM 调用对比

| 项目 | 简单问题 | 中等问题 | 复杂问题 |
|------|---------|---------|----------|
| **AliceLM** | 1次 | 1次 | 1次 |
| **Gemini CLI** | 1-2次 | 2-4次 | 3-6次 |
| **graph-rag-agent** | 1-2次 | 3-5次 | 5-10次 |
| **OpenManus** | 2-3次 | 4-6次 | 6-15次 |
| **SurfSense** | 1-2次 | 2-3次 | 3-5次 |

### 6.5 适用场景对比

```
问题复杂度:    简单 ──────────────────────────────────────→ 复杂

                "摘要"    "对比两个"   "跨视频总结"   "写研究报告"
                  │           │            │              │
AliceLM       ████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
                  │
Gemini CLI    ░░░░░░░░████████████████████░░░░░░░░░░░░░░░░░
                              │
graph-rag-agent ░░░░░░░░░░░░░░░░░░░░████████████████████████
                                            │
OpenManus     ░░░░░░░░░░░░████████████████████████████████
                                  │
SurfSense     ████████████████████████████░░░░░░░░░░░░░░░░░  ⭐ 最接近 AliceLM 定位
                              │
```

### 6.6 开发复杂度对比

| 维度 | AliceLM | Gemini CLI | graph-rag-agent | OpenManus | SurfSense |
|------|---------|-----------|-----------------|-----------|------------|
| **代码量** | 中 | 中 | 大 | 中 | 大 |
| **依赖复杂度** | 低 | 低 | 高 (Neo4j) | 中 | 中 (PG) |
| **学习曲线** | 低 | 低 | 高 | 中 | 中 |
| **可维护性** | 高 | 高 | 中 | 高 | 高 |
| **参考价值** | - | 中 | 中 | 中 | ⭐高 |

---

## 7. AliceLM 升级建议

### 7.1 分阶段路径

```
┌─────────────────────────────────────────────────────────────────┐
│                      AliceLM 升级路径                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  当前状态                                                        │
│  └── 固定 RAG 流程，无动态决策                                   │
│                                                                  │
│       │                                                          │
│       ▼                                                          │
│                                                                  │
│  Phase 1: Function Calling (1周)                                │
│  └── 让模型自己选择工具                                         │
│      ├── 定义工具: search_videos, ask_video, compare...         │
│      ├── 实现工具调用循环                                       │
│      └── 中等复杂度问题支持                                     │
│                                                                  │
│       │                                                          │
│       ▼                                                          │
│                                                                  │
│  Phase 2: ReAct Agent (2周)                                     │
│  └── 显式思考过程                                               │
│      ├── 实现 Think-Act-Observe 循环                            │
│      ├── Agent 继承层次                                         │
│      └── 复杂问题多步推理                                       │
│                                                                  │
│       │                                                          │
│       ▼                                                          │
│                                                                  │
│  Phase 3: Multi-Agent (2周)                                     │
│  └── 多智能体协作                                               │
│      ├── Planner + Executor + Reporter                          │
│      ├── 任务分解与状态追踪                                     │
│      └── 研究级深度分析                                         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 Phase 1: Function Calling 设计

```python
# 工具定义
TOOLS = [
    {
        "name": "search_videos",
        "description": "在知识库中搜索相关视频",
        "parameters": {
            "query": "搜索关键词",
            "limit": "返回数量"
        }
    },
    {
        "name": "get_video_detail",
        "description": "获取视频详细信息和转写",
        "parameters": {
            "video_id": "视频ID"
        }
    },
    {
        "name": "ask_video",
        "description": "针对特定视频提问",
        "parameters": {
            "video_id": "视频ID",
            "question": "问题"
        }
    },
    {
        "name": "compare_videos",
        "description": "对比多个视频的内容",
        "parameters": {
            "video_ids": "视频ID列表",
            "aspect": "对比维度"
        }
    },
    {
        "name": "get_related_concepts",
        "description": "获取相关概念和视频",
        "parameters": {
            "concept": "概念名称"
        }
    }
]

# 执行循环
async def answer_with_tools(question: str, user_id: int):
    messages = [{"role": "user", "content": question}]
    
    while True:
        response = await llm.chat(
            messages=messages,
            tools=TOOLS
        )
        
        if response.tool_calls:
            for tool_call in response.tool_calls:
                result = await execute_tool(tool_call, user_id)
                messages.append({
                    "role": "tool",
                    "content": result,
                    "tool_call_id": tool_call.id
                })
        else:
            return response.content
```

### 7.3 推荐技术选型

| 组件 | 推荐 | 理由 |
|------|------|------|
| **Function Calling** | OpenAI 兼容格式 | 已有基础 |
| **向量存储** | 保持 ChromaDB | 轻量够用 |
| **图谱存储** | ChromaDB 元数据 | 避免引入 Neo4j |
| **缓存** | 内存 + SQLite | 简单有效 |
| **Agent 框架** | 自建简化版 | 控制复杂度 |

### 7.4 预期效果

| 场景 | 当前 | Phase 1 后 | Phase 3 后 |
|------|------|-----------|-----------|
| "这个视频讲了什么" | ✅ | ✅ | ✅ |
| "对比两个视频" | ❌ | ✅ | ✅ |
| "跨视频总结某概念" | ❌ | ⚠️ | ✅ |
| "写一份学习报告" | ❌ | ❌ | ✅ |

---

*文档版本: v2.0*
*最后更新: 2024-12-04*
*新增: SurfSense 深度分析*
